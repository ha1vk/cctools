--- s/fileio.c-	2008-05-29 03:13:24.000000000 +0300
+++ s/fileio.c	2013-12-08 10:09:00.729826238 +0200
@@ -250,7 +250,6 @@
 }
 #endif
 
-
 char *msname(n)
   char *n;
 /* Reduce all path components to MSDOS upper case 8.3 style names. */
@@ -3271,6 +3270,42 @@
 
 
 #ifndef WIN32   /* The Win32 port uses a system-specific variant. */
+
+#ifdef BIONIC_WCTOMB_FIX
+
+size_t wcrtomb(char *s, wchar_t wc, mbstate_t *st)
+{
+	if (!s) return 1;
+	if ((unsigned)wc < 0x80) {
+		*s = wc;
+		return 1;
+	} else if ((unsigned)wc < 0x800) {
+		*s++ = 0xc0 | (wc>>6);
+		*s = 0x80 | (wc&0x3f);
+		return 2;
+	} else if ((unsigned)wc < 0xd800 || (unsigned)wc-0xe000 < 0x2000) {
+		*s++ = 0xe0 | (wc>>12);
+		*s++ = 0x80 | ((wc>>6)&0x3f);
+		*s = 0x80 | (wc&0x3f);
+		return 3;
+	} else if ((unsigned)wc-0x10000 < 0x100000) {
+		*s++ = 0xf0 | (wc>>18);
+		*s++ = 0x80 | ((wc>>12)&0x3f);
+		*s++ = 0x80 | ((wc>>6)&0x3f);
+		*s = 0x80 | (wc&0x3f);
+		return 4;
+	}
+	errno = EILSEQ;
+	return -1;
+}
+
+int wctomb(char *s, wchar_t wc)
+{
+	if (!s) return 0;
+	return wcrtomb(s, wc, 0);
+}
+#endif
+
 /* convert wide character string to multi-byte character string */
 char *wide_to_local_string(wide_string)
   zwchar *wide_string;
